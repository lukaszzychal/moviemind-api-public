#!/bin/bash
#
# Script do testowania integracji OpenAI API
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ü§ñ Testowanie OpenAI API Integration${NC}"
echo ""

# Sprawd≈∫ czy jeste≈õmy w katalogu projektu
if [ ! -d "api" ]; then
    echo -e "${RED}‚ùå B≈ÇƒÖd: Uruchom script z katalogu g≈Ç√≥wnego projektu${NC}"
    exit 1
fi

# Sprawd≈∫ czy .env istnieje
if [ ! -f "api/.env" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Plik api/.env nie istnieje${NC}"
    echo -e "${YELLOW}Tworzenie z env/local.env.example...${NC}"
    cp env/local.env.example api/.env
    echo -e "${GREEN}‚úÖ Plik .env utworzony${NC}"
    echo -e "${YELLOW}‚ö†Ô∏è  Pamiƒôtaj aby dodaƒá OPENAI_API_KEY do api/.env${NC}"
fi

# Sprawd≈∫ czy OpenAI API key jest skonfigurowany
if ! grep -q "OPENAI_API_KEY=sk-" api/.env 2>/dev/null; then
    echo -e "${RED}‚ùå OPENAI_API_KEY nie jest skonfigurowany w api/.env${NC}"
    echo ""
    echo -e "${YELLOW}Jak uzyskaƒá API key:${NC}"
    echo "  1. Przejd≈∫ na: https://platform.openai.com/api-keys"
    echo "  2. Utw√≥rz nowy klucz"
    echo "  3. Dodaj do api/.env: OPENAI_API_KEY=sk-..."
    echo ""
    exit 1
fi

# Sprawd≈∫ czy AI_SERVICE=real
if ! grep -q "AI_SERVICE=real" api/.env 2>/dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  AI_SERVICE nie jest ustawiony na 'real'${NC}"
    echo -e "${YELLOW}Zmieniam na 'real'...${NC}"
    sed -i.bak 's/AI_SERVICE=.*/AI_SERVICE=real/' api/.env
    echo -e "${GREEN}‚úÖ AI_SERVICE=real ustawione${NC}"
fi

echo -e "${GREEN}‚úÖ Konfiguracja sprawdzona${NC}"
echo ""

# Sprawd≈∫ czy Docker dzia≈Ça
if ! docker-compose ps | grep -q "Up"; then
    echo -e "${YELLOW}‚ö†Ô∏è  Docker containers nie sƒÖ uruchomione${NC}"
    echo -e "${YELLOW}Uruchamianie...${NC}"
    docker-compose up -d
    sleep 5
fi

echo -e "${BLUE}üìã Informacje o konfiguracji:${NC}"
echo ""
docker-compose exec -T php php artisan tinker --execute="
    echo 'API Key: ' . (config('services.openai.api_key') ? '‚úÖ Skonfigurowany' : '‚ùå Brak');
    echo 'Model: ' . config('services.openai.model');
    echo 'AI Service: ' . config('services.ai.service');
    echo '';
"

echo ""
echo -e "${BLUE}üß™ Test 1: Bezpo≈õrednie wywo≈Çanie OpenAiClient${NC}"
echo ""

docker-compose exec -T php php artisan tinker --execute="
    try {
        \$client = app(\App\Services\OpenAiClientInterface::class);
        echo 'Wywo≈Çujƒô OpenAI API dla filmu \"test-movie\"...' . PHP_EOL;
        \$response = \$client->generateMovie('test-movie');
        
        if (\$response['success'] ?? false) {
            echo '‚úÖ Sukces!' . PHP_EOL;
            echo 'Title: ' . (\$response['title'] ?? 'N/A') . PHP_EOL;
            echo 'Model: ' . (\$response['model'] ?? 'N/A') . PHP_EOL;
        } else {
            echo '‚ùå B≈ÇƒÖd: ' . (\$response['error'] ?? 'Unknown error') . PHP_EOL;
        }
    } catch (\Exception \$e) {
        echo '‚ùå Exception: ' . \$e->getMessage() . PHP_EOL;
    }
"

echo ""
echo -e "${BLUE}üß™ Test 2: Przez API Endpoint${NC}"
echo ""
echo -e "${YELLOW}Wy≈õlij request:${NC}"
echo "curl -X POST http://localhost:8000/api/v1/generate \\"
echo "  -H 'Content-Type: application/json' \\"
echo "  -d '{\"entity_type\": \"MOVIE\", \"entity_id\": \"test-movie-2\"}'"
echo ""

# Sprawd≈∫ czy endpoint jest dostƒôpny
if curl -s http://localhost:8000/api/v1/movies > /dev/null 2>&1; then
    echo -e "${GREEN}‚úÖ API endpoint dostƒôpny${NC}"
else
    echo -e "${RED}‚ùå API endpoint nie odpowiada${NC}"
    echo -e "${YELLOW}Sprawd≈∫ czy serwer dzia≈Ça: docker-compose logs php${NC}"
fi

echo ""
echo -e "${BLUE}üìä Status Queue${NC}"
echo ""

# Sprawd≈∫ czy Horizon lub queue:work dzia≈Ça
if docker-compose ps | grep -q "horizon.*Up"; then
    echo -e "${GREEN}‚úÖ Horizon uruchomiony${NC}"
elif docker-compose ps | grep -q "queue.*Up"; then
    echo -e "${GREEN}‚úÖ Queue worker uruchomiony${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  Queue worker nie jest uruchomiony${NC}"
    echo -e "${YELLOW}Uruchom: docker-compose up -d horizon${NC}"
    echo -e "${YELLOW}Lub: docker-compose exec php php artisan queue:work${NC}"
fi

echo ""
echo -e "${GREEN}‚úÖ Testy zako≈Ñczone${NC}"
echo ""
echo -e "${BLUE}üìù Przydatne komendy:${NC}"
echo "  - Sprawd≈∫ logi: docker-compose logs -f php"
echo "  - Sprawd≈∫ queue: docker-compose logs -f horizon"
echo "  - Sprawd≈∫ job status: curl http://localhost:8000/api/v1/jobs/{job_id}"
echo "  - Wy≈ÇƒÖcz real AI: zmie≈Ñ AI_SERVICE=mock w api/.env"
echo ""


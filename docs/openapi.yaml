openapi: 3.0.3
info:
  title: MovieMind API
  version: 1.0.0
  description: |
    Public REST API for movies and people with AI-powered descriptions and bios.
    Uses slug-based resource identifiers. When data is missing and the corresponding
    feature flag is enabled, endpoints return 202 Accepted and queue generation.
    
    **Request Tracing:**
    All responses include `X-Request-ID` and `X-Correlation-ID` headers (UUIDv4).
    - `X-Request-ID`: Unique identifier for each request (auto-generated)
    - `X-Correlation-ID`: Identifier for tracking related requests (can be provided by client)
    
    See `docs/REQUEST_ID_CORRELATION_ID.md` for detailed documentation.
servers:
  - url: http://localhost:8000/api
    description: Local
  - url: https://api.example.com/api
    description: Production (example)
tags:
  - name: Movies
  - name: People
  - name: Generation
  - name: Jobs
  - name: Admin
  - name: Health
  - name: Debug
paths:
  /v1/movies:
    get:
      tags: [Movies]
      summary: List movies
      parameters:
        - in: query
          name: q
          schema:
            type: string
          description: Free-text search (title, director, genre)
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Movie'
              examples:
                default:
                  value:
                    data:
                      - id: 1
                        slug: the-matrix-1999
                        title: The Matrix
                        release_year: 1999
                        director: Lana Wachowski & Lilly Wachowski
                        default_description:
                          id: 10
                          locale: en-US
                          text: 'A hacker discovers the true nature of reality and joins a rebellion against the machines.'
                          context_tag: modern
                          origin: GENERATED
                          ai_model: gpt-4o-mini
                        genres:
                          - id: 3
                            name: Science Fiction
                            slug: science-fiction
                        people:
                          - id: 5
                            slug: keanu-reeves
                            name: Keanu Reeves
                        _links:
                          self:
                            href: /api/v1/movies/the-matrix-1999
                          people:
                            - href: /api/v1/people/keanu-reeves
                              title: Keanu Reeves
                              role: ACTOR
                              character_name: Neo
  /v1/movies/{slug}:
    get:
      tags: [Movies]
      summary: Get movie by slug
      description: |
        Returns movie details including all descriptions and synchronized people (actors, directors, writers, producers).
        People are automatically synchronized from TMDb when a movie is first created. The `people` array
        contains actors with their character names and crew members with their roles.
      parameters:
        - in: path
          name: slug
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MovieFull'
              examples:
                default:
                  value:
                    id: 1
                    slug: the-matrix-1999
                    title: The Matrix
                    release_year: 1999
                    director: Lana Wachowski & Lilly Wachowski
                    default_description:
                      id: 10
                      locale: en-US
                      text: 'A hacker discovers the true nature of reality and joins a rebellion against the machines.'
                      context_tag: modern
                      origin: GENERATED
                      ai_model: gpt-4o-mini
                    descriptions:
                      - id: 10
                        locale: en-US
                        text: 'A hacker discovers the true nature of reality and joins a rebellion against the machines.'
                        context_tag: modern
                        origin: GENERATED
                        ai_model: gpt-4o-mini
                    genres:
                      - id: 3
                        name: Science Fiction
                        slug: science-fiction
                    people:
                      - id: 5
                        slug: keanu-reeves
                        name: Keanu Reeves
                        role: ACTOR
                        character_name: Neo
                    _links:
                      self:
                        href: /api/v1/movies/the-matrix-1999
                      people:
                        - href: /api/v1/people/keanu-reeves
                          title: Keanu Reeves
                          role: ACTOR
                          character_name: Neo
                      generate:
                        href: /api/v1/generate
                        method: POST
                        body:
                          entity_type: MOVIE
                          entity_id: 1
                    _meta:
                      matched_slug: the-matrix-1999
                      disambiguation:
                        - slug: the-matrix-1999
                          release_year: 1999
        '202':
          description: Accepted - generation queued (feature flag on)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenerationQueued'
              examples:
                default:
                  value:
                    job_id: 550e8400-e29b-41d4-a716-446655440000
                    status: PENDING
                    message: Generation queued for movie by slug
                    slug: annihilation
                    confidence: 0.78
                    confidence_level: medium
        '404':
          description: Not Found (feature flag off)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
  /v1/movies/{slug}/refresh:
    post:
      tags: [Movies]
      summary: Refresh movie metadata from TMDb
      description: |
        Refreshes movie metadata (title, release_year, director, genres) from TMDb.
        **Important:** This endpoint does NOT synchronize actors/crew. Actor and crew
        synchronization happens automatically when a movie is first created from TMDb data.
        Use this endpoint only to update core movie metadata.
      parameters:
        - in: path
          name: slug
          required: true
          schema:
            type: string
          description: Movie slug identifier
      responses:
        '200':
          description: Movie metadata refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Movie data refreshed from TMDb
                  slug:
                    type: string
                    example: the-matrix-1999
                  movie_id:
                    type: integer
                    example: 1
                  refreshed_at:
                    type: string
                    format: date-time
                    example: '2025-12-17T22:24:13+00:00'
              examples:
                default:
                  value:
                    message: Movie data refreshed from TMDb
                    slug: the-matrix-1999
                    movie_id: 1
                    refreshed_at: '2025-12-17T22:24:13+00:00'
        '404':
          description: Movie not found or no TMDb snapshot exists
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Movie not found
              examples:
                movie_not_found:
                  value:
                    error: Movie not found
                no_snapshot:
                  value:
                    error: No TMDb snapshot found for this movie
  /v1/people:
    get:
      tags: [People]
      summary: List people
      parameters:
        - in: query
          name: q
          schema:
            type: string
          description: Free-text search (name, birthplace, movies)
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Person'
              examples:
                default:
                  value:
                    data:
                      - id: 5
                        slug: keanu-reeves
                        name: Keanu Reeves
                        birth_date: '1964-09-02'
                        birthplace: Beirut, Lebanon
                        default_bio:
                          id: 20
                          locale: en-US
                          text: 'A versatile actor known for his roles in action and science fiction films.'
                          context_tag: modern
                          origin: GENERATED
                          ai_model: gpt-4o-mini
                        bios_count: 1
                        movies:
                          - id: 1
                            slug: the-matrix-1999
                            title: The Matrix
                            role: ACTOR
                            character_name: Neo
                        _links:
                          self:
                            href: /api/v1/people/keanu-reeves
                          movies:
                            - href: /api/v1/movies/the-matrix-1999
                              title: The Matrix
  /v1/people/{slug}:
    get:
      tags: [People]
      summary: Get person by slug
      parameters:
        - in: path
          name: slug
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PersonFull'
              examples:
                default:
                  value:
                    id: 5
                    slug: keanu-reeves
                    name: Keanu Reeves
                    birth_date: '1964-09-02'
                    birthplace: Beirut, Lebanon
                    default_bio:
                      id: 21
                      locale: en-US
                      text: 'Canadian actor known for The Matrix and John Wick franchises.'
                      context_tag: modern
                      origin: GENERATED
                      ai_model: gpt-4o-mini
                    bios:
                      - id: 21
                        locale: en-US
                        text: 'Canadian actor known for The Matrix and John Wick franchises.'
                        context_tag: modern
                        origin: GENERATED
                        ai_model: gpt-4o-mini
                    movies:
                      - id: 1
                        slug: the-matrix-1999
                        title: The Matrix
                        role: ACTOR
                        character_name: Neo
                    _links:
                      self:
                        href: /api/v1/people/keanu-reeves
                      movies:
                        - href: /api/v1/movies/the-matrix-1999
                          title: The Matrix
                          role: ACTOR
                          character_name: Neo
        '202':
          description: Accepted - generation queued (feature flag on)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenerationQueued'
              examples:
                default:
                  value:
                    job_id: 9fa8c917-7d31-4b54-90d1-2ccf4bd8df52
                    status: PENDING
                    message: Generation queued for person by slug
                    slug: john-doe
                    confidence: 0.64
                    confidence_level: low
        '404':
          description: Not Found (feature flag off)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
  /v1/generate:
    post:
      tags: [Generation]
      summary: Queue generation for an entity
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateRequest'
            examples:
              movie:
                summary: Queue movie generation
                value:
                  entity_type: MOVIE
                  entity_id: annihilation-2018
                  locale: en-US
                  context_tag: modern
      responses:
        '202':
          description: Accepted - job queued for generation (new or existing entity)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenerationQueued'
              examples:
                regeneration:
                  value:
                    job_id: 7e1e6e2d-5b5d-4c83-8f6d-83c21c53e4c2
                    status: PENDING
                    message: Generation queued for existing movie slug
                    slug: the-matrix-1999
                    confidence: 0.92
                    confidence_level: high
                    existing_id: 1
                    description_id: 314
                new:
                  value:
                    job_id: 0d3f1976-b7d0-4d18-90d3-ef5d547d9300
                    status: PENDING
                    message: Generation queued for movie by slug
                    slug: annihilation
                    confidence: 0.74
                    confidence_level: medium
        '400':
          description: Invalid payload (slug validation failed)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  message:
                    type: string
                  confidence:
                    type: number
                    format: float
                    nullable: true
                  slug:
                    type: string
        '403':
          description: Feature not available
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
              examples:
                flag-disabled:
                  value:
                    error: Feature not available
  /v1/jobs/{id}:
    get:
      tags: [Jobs]
      summary: Get job status
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Job'
              examples:
                queued:
                  value:
                    job_id: 0d3f1976-b7d0-4d18-90d3-ef5d547d9300
                    status: PENDING
                    entity: MOVIE
                    slug: annihilation
                    confidence: 0.74
                completed:
                  value:
                    job_id: 1f52d5f2-3cdc-4c1b-8726-762ebf49ea4b
                    status: DONE
                    entity: MOVIE
                    entity_id: 1
                    slug: the-matrix-1999
                failed:
                  value:
                    job_id: 559d53db-bb14-46ca-928e-d600b3cf6b3a
                    status: FAILED
                    entity: MOVIE
                    slug: test-movie-123
                    requested_slug: test-movie-123
                    locale: en-US
                    error:
                      type: NOT_FOUND
                      message: The requested movie was not found
                      technical_message: Movie not found: test-movie-123
                      user_message: This movie does not exist in our database
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_id:
                    type: string
                  status:
                    type: string
              examples:
                unknown:
                  value:
                    job_id: 11111111-1111-1111-1111-111111111111
                    status: UNKNOWN
  /v1/health/openai:
    get:
      tags: [Health]
      summary: Check OpenAI connectivity
      description: Performs a lightweight request to verify that OpenAI credentials work and the API is reachable.
      responses:
        '200':
          description: OpenAI reachable
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  status:
                    type: integer
                  model:
                    type: string
                  rate_limit:
                    type: object
                    additionalProperties: true
              examples:
                default:
                  value:
                    success: true
                    message: OpenAI API reachable
                    status: 200
                    model: gpt-4o-mini
                    rate_limit:
                      requests_remaining: "2"
  /v1/admin/debug/config:
    get:
      tags: [Admin]
      summary: Debug service configuration
      description: |
        Debug endpoint to inspect service configuration, including AI_SERVICE, OpenAI settings, and other service parameters.
        
        **Security:**
        - Protected by feature flag `debug_endpoints` (default: disabled)
        - Enable via feature flag API: `POST /api/v1/admin/flags/debug_endpoints` with body `{"state": "on"}`
        - Disabled by default in production for security
        
        **Note:** This endpoint is intended for development and debugging purposes. Keep the feature flag disabled in production unless needed for troubleshooting.
      responses:
        '200':
          description: Configuration data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DebugConfig'
              examples:
                default:
                  value:
                    environment:
                      app_env: local
                      app_debug: true
                      ai_service_env: real
                      ai_service_config: real
                      ai_service_selector: real
                      is_real: true
                      is_mock: false
                    openai:
                      api_key_set: true
                      api_key_preview: sk-proj-ap...
                      model: gpt-4o-mini
                      api_url: https://api.openai.com/v1/chat/completions
                      health_url: https://api.openai.com/v1/models
                      backoff_enabled: true
                      backoff_intervals: [20, 60, 180]
                    queue:
                      connection: redis
                      redis_host: redis
                    cache:
                      driver: database
                    database:
                      connection: pgsql
                      host: db
                    services:
                      openai_client_class: App\Services\OpenAiClient
                      openai_client_interface: App\Services\OpenAiClientInterface
                    timestamp: "2025-11-29T22:43:12+00:00"
                    note: This endpoint is protected by the "debug_endpoints" feature flag. Disabled by default in production.
        '403':
          description: Forbidden (feature flag disabled)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  message:
                    type: string
              examples:
                forbidden:
                  value:
                    error: Forbidden
                    message: Debug endpoints are disabled. Enable feature flag "debug_endpoints" to access this endpoint.
                      tokens_remaining: "5000"
        '503':
          description: OpenAI unavailable
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  error:
                    type: string
                  status:
                    type: integer
  /v1/admin/flags:
    get:
      tags: [Admin]
      summary: List feature flags
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/FeatureFlag'
              examples:
                default:
                  value:
                    data:
                      - name: ai_description_generation
                        active: true
                        description: Enables AI-generated movie/series descriptions.
                        category: core_ai
                        default: true
                        togglable: true
                      - name: ai_bio_generation
                        active: false
                        description: Enables AI-generated person biographies.
                        category: core_ai
                        default: true
                        togglable: true
                      - name: tmdb_verification
                        active: true
                        description: TMDb API verification for movies and people before AI generation. Verifies entity existence in TMDb before queueing AI generation job.
                        category: moderation
                        default: true
                        togglable: true
  /v1/admin/flags/{name}:
    post:
      tags: [Admin]
      summary: Toggle a feature flag
      parameters:
        - in: path
          name: name
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                state:
                  type: string
                  enum: [on, off]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeatureFlagToggle'
              examples:
                default:
                  value:
                    name: ai_description_generation
                    active: true
  /v1/admin/flags/usage:
    get:
      tags: [Admin]
      summary: Flags usage metrics
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  usage:
                    type: array
                    items:
                      $ref: '#/components/schemas/FeatureFlagUsage'
              examples:
                default:
                  value:
                    usage:
                      - file: app/Http/Controllers/Api/MovieController.php
                        line: 42
                        pattern: active
                        name: ai_description_generation
components:
  headers:
    XRequestID:
      description: Unique identifier for this HTTP request (UUIDv4). Use this ID to trace logs and debug issues.
      schema:
        type: string
        format: uuid
        example: 550e8400-e29b-41d4-a716-446655440000
    XCorrelationID:
      description: Identifier to track related requests across services or user sessions (UUIDv4). If provided by client in X-Correlation-ID header, the same value is returned. Otherwise, a new UUIDv4 is generated.
      schema:
        type: string
        format: uuid
        example: 7c9e6679-7425-40de-944b-e07fc1f90ae7
  parameters:
  schemas:
    Genre:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        slug:
          type: string
    Movie:
      type: object
      properties:
        id:
          type: integer
        slug:
          type: string
        title:
          type: string
        release_year:
          type: integer
          nullable: true
        director:
          type: string
          nullable: true
        default_description:
          $ref: '#/components/schemas/MovieDescription'
        genres:
          type: array
          items:
            $ref: '#/components/schemas/Genre'
        people:
          type: array
          items:
            $ref: '#/components/schemas/PersonContribution'
        _links:
          type: object
          additionalProperties: true
    MovieDescription:
      type: object
      properties:
        id:
          type: integer
        locale:
          type: string
        text:
          type: string
        context_tag:
          type: string
        origin:
          type: string
        ai_model:
          type: string
    MovieFull:
      allOf:
        - $ref: '#/components/schemas/Movie'
        - type: object
          properties:
            descriptions:
              type: array
              items:
                $ref: '#/components/schemas/MovieDescription'
            _meta:
              type: object
              additionalProperties: true
    PersonContribution:
      type: object
      properties:
        id:
          type: integer
        slug:
          type: string
        name:
          type: string
        role:
          type: string
          nullable: true
        character_name:
          type: string
          nullable: true
    Person:
      type: object
      properties:
        id:
          type: integer
        slug:
          type: string
        name:
          type: string
        birth_date:
          type: string
          format: date
          nullable: true
        birthplace:
          type: string
          nullable: true
        default_bio:
          $ref: '#/components/schemas/PersonBio'
        bios:
          type: array
          items:
            $ref: '#/components/schemas/PersonBio'
        movies:
          type: array
          items:
            $ref: '#/components/schemas/MovieContribution'
        _links:
          type: object
          additionalProperties: true
    PersonBio:
      type: object
      properties:
        id:
          type: integer
        locale:
          type: string
        text:
          type: string
        context_tag:
          type: string
        origin:
          type: string
        ai_model:
          type: string
    PersonFull:
      allOf:
        - $ref: '#/components/schemas/Person'
        - type: object
          properties:
            _meta:
              type: object
              additionalProperties: true
    MovieContribution:
      type: object
      properties:
        id:
          type: integer
        slug:
          type: string
        title:
          type: string
        role:
          type: string
          nullable: true
        character_name:
          type: string
          nullable: true
    FeatureFlag:
      type: object
      properties:
        name:
          type: string
        active:
          type: boolean
        description:
          type: string
          nullable: true
        category:
          type: string
          nullable: true
        default:
          type: boolean
        togglable:
          type: boolean
    FeatureFlagToggle:
      type: object
      properties:
        name:
          type: string
        active:
          type: boolean
    FeatureFlagUsage:
      type: object
      properties:
        file:
          type: string
        line:
          type: integer
        pattern:
          type: string
        name:
          type: string
    Job:
      type: object
      properties:
        job_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [PENDING, DONE, FAILED, UNKNOWN]
        entity:
          type: string
          enum: [MOVIE, PERSON]
        entity_id:
          type: integer
          nullable: true
        slug:
          type: string
          nullable: true
        confidence:
          type: number
          format: float
          nullable: true
        error:
          type: object
          nullable: true
          properties:
            type:
              type: string
              enum: [NOT_FOUND, AI_API_ERROR, VALIDATION_ERROR, UNKNOWN_ERROR]
            message:
              type: string
              description: Short technical error message
            technical_message:
              type: string
              description: Full exception message for debugging
            user_message:
              type: string
              description: User-friendly error message
        description_id:
          type: integer
          nullable: true
        bio_id:
          type: integer
          nullable: true
    DebugConfig:
      type: object
      description: Debug configuration response
      properties:
        environment:
          type: object
          properties:
            app_env:
              type: string
            app_debug:
              type: boolean
            ai_service_env:
              type: string
              nullable: true
            ai_service_config:
              type: string
            ai_service_selector:
              type: string
            is_real:
              type: boolean
            is_mock:
              type: boolean
        openai:
          type: object
          properties:
            api_key_set:
              type: boolean
            api_key_preview:
              type: string
              nullable: true
            model:
              type: string
            api_url:
              type: string
            health_url:
              type: string
            backoff_enabled:
              type: boolean
            backoff_intervals:
              type: array
              items:
                type: integer
        queue:
          type: object
          properties:
            connection:
              type: string
            redis_host:
              type: string
              nullable: true
        cache:
          type: object
          properties:
            driver:
              type: string
        database:
          type: object
          properties:
            connection:
              type: string
            host:
              type: string
              nullable: true
        services:
          type: object
          properties:
            openai_client_class:
              type: string
            openai_client_interface:
              type: string
        timestamp:
          type: string
          format: date-time
        note:
          type: string
    GenerationQueued:
      type: object
      required: [job_id, status, message, slug]
      properties:
        job_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [PENDING]
        message:
          type: string
        slug:
          type: string
        confidence:
          type: number
          format: float
          nullable: true
        confidence_level:
          type: string
          nullable: true
        description_id:
          type: integer
          nullable: true
        bio_id:
          type: integer
          nullable: true
        existing_id:
          type: integer
          nullable: true
    GenerationCompleted:
      type: object
      required: [job_id, status, message, slug, id]
      properties:
        job_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [DONE]
        message:
          type: string
        slug:
          type: string
        id:
          type: integer
        confidence:
          type: number
          format: float
          nullable: true
        confidence_level:
          type: string
          nullable: true
    GenerateRequest:
      type: object
      required: [entity_type]
      properties:
        entity_type:
          type: string
          enum: [MOVIE, ACTOR, PERSON]
          description: Entity type to generate content for.
        slug:
          type: string
          description: Preferred identifier for the entity (e.g. `the-matrix-1999`). Required when `entity_id` is omitted.
          example: the-matrix-1999
        entity_id:
          type: string
          description: Alias for `slug` used by legacy clients (still accepted). Required when `slug` is omitted.
          example: the-matrix-1999
        locale:
          type: string
          example: en-US
        context_tag:
          type: string
          example: modern
      oneOf:
        - required: [slug]
        - required: [entity_id]



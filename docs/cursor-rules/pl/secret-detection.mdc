---
alwaysApply: true
---

# Secret Detection

## Basic principle

**ALWAYS check secrets before commit and push. Zero tolerance for secrets in repository.**

## Automatic Git Hooks Installation

**ALWAYS before commit or push - automatically check and install hooks:**

1. **Check if hooks are installed:**
   ```bash
   if [ ! -f ".git/hooks/pre-commit" ]; then
       # Automatically install hooks
       if [ -f "scripts/git-hooks/pre-commit" ]; then
           cp scripts/git-hooks/pre-commit .git/hooks/pre-commit
           chmod +x .git/hooks/pre-commit
           echo "✅ Git hooks installed automatically"
       else
           echo "⚠️  Git hooks template not found at scripts/git-hooks/pre-commit"
       fi
   fi
   ```

2. **For AI Agent - automatic installation:**
   - Before every `git commit` or `git push`, check if `.git/hooks/pre-commit` exists
   - If it doesn't exist, automatically install from `scripts/git-hooks/pre-commit`
   - Make sure the hook has execute permissions (`chmod +x`)
   - Do not ask user - execute automatically

2. **Check if GitLeaks is installed:**
   ```bash
   if ! command -v gitleaks &> /dev/null; then
       echo "⚠️  GitLeaks not installed. Install with: brew install gitleaks"
       echo "⚠️  Or run: ./scripts/setup-pre-commit.sh"
       # Don't block, but warn user
   fi
   ```

## Secret verification before commit

**BEFORE EVERY COMMIT:**

1. **Run GitLeaks on staged files:**
   ```bash
   gitleaks protect --source . --verbose --no-banner --staged
   ```

2. **If secrets are detected:**
   - ❌ **BLOCK commit**
   - Inform user about detected secrets
   - Show secret locations (files, lines)
   - Suggest removing secrets and using environment variables

3. **If GitLeaks is not installed:**
   - ⚠️ Warn user
   - Suggest installation: `brew install gitleaks` or `./scripts/setup-pre-commit.sh`
   - **DO NOT BLOCK** commit, but clearly warn

## Secret verification before push

**BEFORE EVERY PUSH:**

1. **Run GitLeaks on entire repository:**
   ```bash
   gitleaks protect --source . --verbose --no-banner
   ```

2. **If secrets are detected:**
   - ❌ **BLOCK push**
   - Inform user about detected secrets
   - Check commit history - secret might be in old commit
   - Suggest using `git filter-branch` or `git filter-repo` to remove secrets from history

## Types of secrets to detect

GitLeaks detects:
- API keys (OpenAI, AWS, Google Cloud, etc.)
- Passwords
- Tokens (JWT, OAuth, etc.)
- Private keys (SSH, GPG, etc.)
- Database credentials
- Secret keys and seed phrases

## Files to check

**Always check:**
- `.env` and `.env.*` (should be in `.gitignore`)
- `.env.bak` and `*.env.bak` (should be in `.gitignore`)
- Configuration files with passwords
- Files with hardcoded credentials
- Backup files with secrets

## Pre-commit workflow

```bash
# 1. Check if hooks are installed
if [ ! -f ".git/hooks/pre-commit" ]; then
    cp scripts/git-hooks/pre-commit .git/hooks/pre-commit
    chmod +x .git/hooks/pre-commit
fi

# 2. Check secrets
if command -v gitleaks &> /dev/null; then
    gitleaks protect --source . --verbose --no-banner --staged
    if [ $? -ne 0 ]; then
        echo "❌ Secrets detected! Commit blocked."
        exit 1
    fi
else
    echo "⚠️  GitLeaks not installed. Install with: brew install gitleaks"
fi

# 3. Continue with other checks (Pint, PHPStan, etc.)
```

## Pre-push workflow

```bash
# 1. Check secrets in entire repository
if command -v gitleaks &> /dev/null; then
    gitleaks protect --source . --verbose --no-banner
    if [ $? -ne 0 ]; then
        echo "❌ Secrets detected! Push blocked."
        exit 1
    fi
else
    echo "⚠️  GitLeaks not installed. Install with: brew install gitleaks"
    echo "⚠️  Proceeding without secret check (NOT RECOMMENDED)"
fi
```

## What to do when secret is detected

1. **Remove secret from file:**
   - Replace secret with environment variable
   - Use `.env` for local values
   - Use GitHub Secrets for CI/CD

2. **If secret is in commit history:**
   - Use `git filter-branch` or `git filter-repo` to remove from history
   - Regenerate secret (API key, password, etc.)
   - Update all places where secret was used

3. **Update `.gitignore`:**
   - Make sure files with secrets are ignored
   - Add patterns for backup files (`.env.bak`, `*.bak`)

## Tools

- **GitLeaks** - main tool for secret detection
- **GitHub Push Protection** - backup at GitHub level (works after push)
- **Git hooks** - local protection before commit

## Priority

**Security > Everything Else**

Secrets in repository are a critical security issue. Always check before commit and push.

---
alwaysApply: true
---

# Test Driven Development (TDD)

## ⚠️ REQUIRED BEFORE EVERY CODE CHANGE

**BEFORE starting implementation you MUST:**

### 1. TDD Workflow Checklist (MANDATORY)

**BEFORE writing any implementation code:**

- [ ] **RED** - I wrote a test that defines expected behavior
- [ ] **RED** - I ran the test - test FAILS (this is OK, this is the RED goal)
- [ ] **GREEN** - I wrote minimal code needed to pass the test
- [ ] **GREEN** - I ran the test - test PASSES
- [ ] **REFACTOR** - I improved the code while keeping tests passing
- [ ] **REFACTOR** - I ran tests again - all PASS

**If changing existing code:**
- [ ] First I changed tests to expect new behavior (RED)
- [ ] I ran tests - tests FAIL (this is OK)
- [ ] I changed code so tests pass (GREEN)
- [ ] I refactored code (REFACTOR)

**If fixing a bug:**
- [ ] First I wrote a test reproducing the bug (RED - test fails)
- [ ] I fixed the bug in code (GREEN - test passes)
- [ ] I refactored code (REFACTOR)

## Basic principle

**Always write tests before implementation. Red-Green-Refactor cycle.**

## TDD Cycle

1. **RED** - Write a test that defines expected behavior
   - Test should FAIL (this is the goal - we show that functionality doesn't exist)
   - Run test: `php artisan test --filter=test_name`
   - Verify that test fails with expected error
   
2. **GREEN** - Write minimal code needed to pass the test
   - Write ONLY as much code as needed to pass the test
   - Run test: `php artisan test --filter=test_name`
   - Verify that test passes
   
3. **REFACTOR** - Improve code while keeping tests passing
   - Improve code (readability, performance, structure)
   - Run tests again: `php artisan test`
   - Verify that all tests still pass

## ✅ Always

- **Write tests before code** - test first, then implementation
- **Run tests after each change** - `php artisan test`
- **New code requires tests** - no exceptions
- **Feature Tests** for API endpoints (`tests/Feature/`)
- **Unit Tests** for business logic (`tests/Unit/`)

## ❌ NEVER

- ❌ **Do not write implementation code before writing tests** - this violates TDD principle
- ❌ Do not commit code without tests
- ❌ Do not skip tests "because it's a small change"
- ❌ Do not ignore failing tests
- ❌ Do not change code before changing tests (even if it's refactoring)

## Test types

- **Feature Tests** (`tests/Feature/`) - API endpoints and integration
- **Unit Tests** (`tests/Unit/`) - business logic and services

## Example of correct TDD workflow

```php
// 1. RED - Test defines requirement (test FAILS)
public function test_movie_disambiguation_uses_slugs_instead_of_tmdb_id(): void
{
    $response = $this->getJson('/api/v1/movies/bad-boys');
    
    $response->assertStatus(300)
        ->assertJsonMissing(['options' => [['tmdb_id' => 9738]]]) // We expect NO tmdb_id
        ->assertJsonStructure(['options' => [['slug']]]); // We expect slug EXISTS
}
// Run: php artisan test --filter=test_movie_disambiguation_uses_slugs
// Result: FAIL (because code still uses tmdb_id) ✅ This is OK!

// 2. GREEN - Minimal implementation (test PASSES)
// Change code in MovieRetrievalService::buildDisambiguationOptions()
// Run: php artisan test --filter=test_movie_disambiguation_uses_slugs
// Result: PASS ✅

// 3. REFACTOR - Improve code (tests still PASS)
// Improve readability, performance, etc.
// Run: php artisan test
// Result: All tests PASS ✅
```

---
alwaysApply: true
---

# Pre-Commit Workflow (REQUIRED)

## Before each commit you MUST run and fix:

### 1. Laravel Pint (formatting)
```bash
cd api && vendor/bin/pint
```

### 2. PHPStan (static analysis)
```bash
cd api && vendor/bin/phpstan analyse --memory-limit=2G
```
Level: 5. Zero errors before commit.

#### PHPStan log archiving
- After each PHPStan run, save the full output (`stdout` + `stderr`) to a log file.
- Use the `docs/logs/phpstan/` directory (create on first use, e.g. `mkdir -p docs/logs/phpstan`).
- File name: `phpstan-YYYYMMDD-HHMMSS.log` (e.g. `phpstan-20251109-153000.log`).
- Recommended command:
```bash
cd api && vendor/bin/phpstan analyse --memory-limit=2G 2>&1 | tee ../docs/logs/phpstan/phpstan-$(date +"%Y%m%d-%H%M%S").log
```
- Do not delete existing log files ‚Äî they will be needed in future projects.

### 3. PHPUnit (tests)
```bash
cd api && php artisan test
```
All tests must pass.

### 4. GitLeaks (secrets)
```bash
gitleaks protect --source . --verbose --no-banner
```
Zero detected secrets.

### 5. Composer Audit (security)
```bash
cd api && composer audit
```
Fix critical vulnerabilities before commit.

### 6. API Documentation Update (if endpoints changed)
**IMPORTANT:** If you added/changed/removed API endpoints, **ALWAYS** update:

#### OpenAPI Spec
```bash
# Update docs/openapi.yaml
# Add/change/remove endpoints according to code changes
```

#### Postman Collection
```bash
# Update docs/postman/moviemind-api.postman_collection.json
# Add/change/remove requests according to API changes
```

#### Insomnia Collection
```bash
# Update docs/insomnia/moviemind-api-insomnia.json
# Add/change/remove requests according to API changes
```

**When to update:**
- ‚úÖ Added new endpoint
- ‚úÖ Changed endpoint path
- ‚úÖ Changed request/response parameters
- ‚úÖ Removed endpoint
- ‚úÖ Changed status codes
- ‚úÖ Added/changed authorization

**Update format:**
- OpenAPI: According to OpenAPI 3.0 format
- Postman: JSON format compatible with Postman Collection v2.1
- Insomnia: JSON format compatible with Insomnia Export

## Complete check (everything at once)

```bash
cd api && \
  vendor/bin/pint && \
  vendor/bin/phpstan analyse --memory-limit=2G && \
  php artisan test && \
  gitleaks protect --source . --verbose --no-banner && \
  composer audit
```

**Remember:** After API changes, always update documentation!

## Branch Workflow (default rule)

- **90% of tasks** should be done on short feature branches (`feature/‚Ä¶`) covering one cohesive topic.
- Each branch should end with a pull request to `main` (you can approve yourself, but PR and diff are mandatory).
- `main` must remain always deployable; merge only after tests/pre-commits pass.
- Longer, multi-week branches should be used only in exceptional reconstructions ‚Äî then divide work into smaller PRs.
- **Commit messages** must be written only in English, in the style `type: short description` (e.g. `feat: add movie resource`). Messages in other languages are not allowed.
- Agent can execute `git commit`, but `git push` runs only on explicit user command.

## Immediate commits

- After each change in Cursor rules files (`.cursor/rules/*.mdc`), perform an immediate commit covering these files.
- After adding a new task or updating content of an existing task in `docs/issue/**/*.md`, immediately commit these changes in a separate commit.

## Task management (TASKS.md)

- After starting a task, **change status to `üîÑ IN_PROGRESS`**, enter `Start time` (with minute precision) and mark the executor (`ü§ñ/üë®‚Äçüíª/‚öôÔ∏è`).
- After completing a task:
  - fill in `End time` and **calculate `Duration`** (format `HHhMMm`), even when the shortcut says AUTO,
  - change status to `‚úÖ COMPLETED`,
  - **move the entire task block to the "‚úÖ Completed Tasks" section**,
  - add a short description of work performed (e.g. list of key changes).
- Do not leave completed tasks in the "Active" section. This section should contain only tasks with status `‚è≥` or `üîÑ`.
- After updating `TASKS.md`, trigger the synchronization workflow (push/merge to `main` or manually in GitHub Actions) to keep Issues consistent.

## Documentation (PL / EN)

- Each document must have Polish and English versions (e.g. in `docs/‚Ä¶/pl` and `docs/‚Ä¶/en`).
- When modifying one language, **immediately** update the other ‚Äî lack of synchronization is treated as a review error.
- If content is long, summaries are acceptable, but both languages must contain complete key information and link to each other.
- Index files (e.g. `docs/issue/README.md`) should clearly indicate where PL and EN versions are located.

## Cursor Rules Synchronization (EN ‚Üî PL)

**IMPORTANT:** Files in `.cursor/rules/*.mdc` and `CLAUDE.md` are in English version (used by Cursor/Claude). Polish versions are located in documentation for learning English purposes.

### Synchronization rules:

- **When you change a file in `.cursor/rules/*.mdc` or `CLAUDE.md`:**
  - **ALWAYS** update the corresponding Polish version in `docs/cursor-rules/pl/*.mdc` or `docs/CLAUDE.pl.md`
  - Versions must be synchronized - lack of synchronization is treated as a review error
  - Update both versions in the same commit or in subsequent commits (don't leave the Polish version unsynchronized)

- **When you add a new file in `.cursor/rules/*.mdc`:**
  - **ALWAYS** create a Polish version in `docs/cursor-rules/pl/` with the same filename
  - New file must have both versions (EN in `.cursor/rules/`, PL in `docs/cursor-rules/pl/`)

- **When you add a new section or rule:**
  - Add it first in English version (in `.cursor/rules/*.mdc` or `CLAUDE.md`)
  - **Immediately** add Polish translation in the corresponding file in `docs/cursor-rules/pl/` or `docs/CLAUDE.pl.md`

- **Structure:**
  - `.cursor/rules/*.mdc` - English versions (used by Cursor/Claude)
  - `CLAUDE.md` - English version (used by Cursor/Claude)
  - `docs/cursor-rules/pl/*.mdc` - Polish versions (for learning English)
  - `docs/CLAUDE.pl.md` - Polish version (for learning English)

**Remember:** Polish versions serve to learn English by comparing with English versions. Cursor/Claude uses only English versions from `.cursor/rules/` and `CLAUDE.md`.

## External links and proper nouns

- When providing publicly available proper nouns (e.g. online stores, providers), **always** include a reliable URL link next to it.
- Each external link **must be verified** (open/test check) to ensure it is active and leads to the correct source.
- If you cannot confirm a link, **clearly mark it**, adding an alternative source or warning.
- Format responses clearly (headers, bullet lists) according to Cursor guidelines.

## Manual testing

- **ALWAYS** manually test tasks and functions that can be tested without automated tests.
- **Report in real-time** on testing steps and results:
  - Describe each testing step (e.g. "Testing endpoint GET /api/v1/movies/{slug}")
  - Provide results of each test (success/error, status code, response time, etc.)
  - Report encountered problems or unexpected behaviors
  - Report testing progress (e.g. "Tested 3/5 scenarios")
- Before completing a task, verify that the implementation works correctly in practice (e.g. by calling the API endpoint, checking the response, verifying behavior in the browser).
- If testing requires running Docker or another tool (e.g. Redis, Horizon, PostgreSQL), **always inform the user**:
  - What tool is needed
  - How to run it (e.g. `docker compose up -d`, `php artisan horizon`)
  - What commands to execute for verification
  - Where to check results (logs, dashboard, etc.)
- Examples of situations requiring manual testing:
  - New API endpoints (checking response, status codes, JSON format)
  - Integrations with external services (OpenAI, etc.)
  - UI/UX changes (if applicable)
  - Features requiring user interaction
  - Scenarios difficult to test automatically (e.g. race conditions, timing issues)
- If manual testing is not possible or would require too much time, inform the user about this and propose an alternative approach (e.g. automated tests, documentation, etc.).

## Reporting AI model and tokens

- **ALWAYS** inform the user which AI model you are using at the beginning of the response or when it is relevant to the context.
- Format: `**AI Model used:** [model name]` (e.g. `Claude Sonnet 4.5 (Auto)`, `OpenAI gpt-4o-mini`).
- If token information (used/remaining) is available and **providing it does not consume additional tokens**, you can include it:
  - Basic format: `**Tokens:** used: X, remaining: Y` (or similar, depending on available data).
  - If detailed token information for prompt/response or input/output is available, you can provide it:
    - Format: `**Tokens:** input: X, output: Y, total: Z` or `**Tokens:** prompt: X, response: Y, total: Z`
    - Include only information that is available and whose provision does not consume additional tokens.
- If token information is not available or providing it would consume additional tokens, omit this information.
- In the context of the MovieMind API application, if you mention the model used by the application (e.g. OpenAI), always provide the full model name (e.g. `gpt-4o-mini`).

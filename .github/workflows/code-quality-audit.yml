name: Code Quality Audit

on:
  # Manual trigger for comprehensive code quality audits
  workflow_dispatch:
  # Quarterly comprehensive audit (first day of quarter at 2 AM UTC)
  schedule:
    - cron: '0 2 1 1,4,7,10 *'
  # Semi-annually detailed audit (first day of January and July at 3 AM UTC)
  schedule:
    - cron: '0 3 1 1,7 *'

permissions:
  contents: read
  actions: read

jobs:
  phpstan-analysis:
    name: PHPStan Static Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, dom, curl, libxml, zip, sqlite3, pdo_sqlite
      
      - name: Cache Composer packages
        uses: actions/cache@v4
        with:
          path: api/vendor
          key: ${{ runner.os }}-php-8.3-${{ hashFiles('api/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-8.3-
      
      - name: Install dependencies
        working-directory: api
        run: composer install --prefer-dist --no-progress --no-interaction
      
      - name: Run PHPStan
        working-directory: api
        continue-on-error: true
        run: |
          vendor/bin/phpstan analyse --memory-limit=2G --error-format=json > ../phpstan-results.json || true
      
      - name: Upload PHPStan Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: phpstan-results
          path: phpstan-results.json
          retention-days: 90

  test-coverage:
    name: Test Coverage Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, dom, curl, libxml, zip, sqlite3, pdo_sqlite
          coverage: xdebug
      
      - name: Cache Composer packages
        uses: actions/cache@v4
        with:
          path: api/vendor
          key: ${{ runner.os }}-php-8.3-${{ hashFiles('api/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-8.3-
      
      - name: Install dependencies
        working-directory: api
        run: composer install --prefer-dist --no-progress --no-interaction
      
      - name: Run tests with coverage
        working-directory: api
        continue-on-error: true
        run: |
          php artisan test --coverage --min=80 || true
      
      - name: Generate coverage report
        working-directory: api
        continue-on-error: true
        run: |
          php artisan test --coverage --coverage-html=../coverage-report || true
      
      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage-report
          retention-days: 90

  code-quality-metrics:
    name: Code Quality Metrics
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, dom, curl, libxml, zip, sqlite3, pdo_sqlite
      
      - name: Cache Composer packages
        uses: actions/cache@v4
        with:
          path: api/vendor
          key: ${{ runner.os }}-php-8.3-${{ hashFiles('api/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-8.3-
      
      - name: Install dependencies
        working-directory: api
        run: composer install --prefer-dist --no-progress --no-interaction
      
      - name: Generate Code Quality Report
        working-directory: api
        continue-on-error: true
        run: |
          echo "## Code Quality Metrics Report" > ../code-quality-metrics.md
          echo "" >> ../code-quality-metrics.md
          echo "### Audit Date: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)" >> ../code-quality-metrics.md
          echo "" >> ../code-quality-metrics.md
          echo "### PHPStan Level" >> ../code-quality-metrics.md
          echo "- Current Level: 5" >> ../code-quality-metrics.md
          echo "- Status: ✅ Maintained" >> ../code-quality-metrics.md
          echo "" >> ../code-quality-metrics.md
          echo "### Test Coverage" >> ../code-quality-metrics.md
          echo "- Target: 80%" >> ../code-quality-metrics.md
          echo "- Check test coverage report artifact" >> ../code-quality-metrics.md
          echo "" >> ../code-quality-metrics.md
          echo "### Code Quality Tools" >> ../code-quality-metrics.md
          echo "- Laravel Pint: ✅ Active" >> ../code-quality-metrics.md
          echo "- PHPStan: ✅ Active (Level 5)" >> ../code-quality-metrics.md
          echo "- PHPUnit: ✅ Active" >> ../code-quality-metrics.md
          echo "" >> ../code-quality-metrics.md
          echo "### Recommendations" >> ../code-quality-metrics.md
          echo "1. Review PHPStan results for potential improvements" >> ../code-quality-metrics.md
          echo "2. Ensure test coverage is above 80%" >> ../code-quality-metrics.md
          echo "3. Conduct manual code review for code smells" >> ../code-quality-metrics.md
          echo "4. Check for SOLID violations in new code" >> ../code-quality-metrics.md
          echo "5. Verify DRY principle compliance" >> ../code-quality-metrics.md
      
      - name: Upload Code Quality Metrics
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-quality-metrics
          path: code-quality-metrics.md
          retention-days: 90

  # Aggregate results from all jobs
  aggregate-results:
    name: Aggregate Code Quality Results
    runs-on: ubuntu-latest
    needs: [phpstan-analysis, test-coverage, code-quality-metrics]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Generate Comprehensive Report
        run: |
          echo "# Code Quality Audit Report" > comprehensive-code-quality-audit.md
          echo "" >> comprehensive-code-quality-audit.md
          echo "### Audit Date: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)" >> comprehensive-code-quality-audit.md
          echo "" >> comprehensive-code-quality-audit.md
          echo "### Summary" >> comprehensive-code-quality-audit.md
          echo "" >> comprehensive-code-quality-audit.md
          echo "This comprehensive code quality audit includes:" >> comprehensive-code-quality-audit.md
          echo "" >> comprehensive-code-quality-audit.md
          echo "1. **PHPStan Static Analysis** - Type checking and static analysis" >> comprehensive-code-quality-audit.md
          echo "2. **Test Coverage Analysis** - Test coverage metrics (target: 80%)" >> comprehensive-code-quality-audit.md
          echo "3. **Code Quality Metrics** - Overall code quality assessment" >> comprehensive-code-quality-audit.md
          echo "" >> comprehensive-code-quality-audit.md
          echo "### Results" >> comprehensive-code-quality-audit.md
          echo "" >> comprehensive-code-quality-audit.md
          echo "Check workflow artifacts for detailed results:" >> comprehensive-code-quality-audit.md
          echo "" >> comprehensive-code-quality-audit.md
          echo "- **PHPStan Results** - Static analysis findings" >> comprehensive-code-quality-audit.md
          echo "- **Coverage Report** - Test coverage HTML report" >> comprehensive-code-quality-audit.md
          echo "- **Code Quality Metrics** - Summary metrics and recommendations" >> comprehensive-code-quality-audit.md
          echo "" >> comprehensive-code-quality-audit.md
          echo "### Manual Audit Checklist" >> comprehensive-code-quality-audit.md
          echo "" >> comprehensive-code-quality-audit.md
          echo "For comprehensive manual audit, refer to:" >> comprehensive-code-quality-audit.md
          echo "- [Code Quality Audits Guide](../../docs/knowledge/technical/CODE_QUALITY_AUDITS_GUIDE.md)" >> comprehensive-code-quality-audit.md
          echo "" >> comprehensive-code-quality-audit.md
          echo "### Next Steps" >> comprehensive-code-quality-audit.md
          echo "" >> comprehensive-code-quality-audit.md
          echo "1. Review PHPStan results and fix any issues" >> comprehensive-code-quality-audit.md
          echo "2. Ensure test coverage is above 80%" >> comprehensive-code-quality-audit.md
          echo "3. Conduct manual code review for code smells and SOLID violations" >> comprehensive-code-quality-audit.md
          echo "4. Create tasks for issues requiring fixes" >> comprehensive-code-quality-audit.md
          echo "" >> comprehensive-code-quality-audit.md
          echo "---" >> comprehensive-code-quality-audit.md
          echo "" >> comprehensive-code-quality-audit.md
          echo "**Note:** This is an automated code quality audit. Manual audits should be conducted quarterly/semi-annually according to the guide." >> comprehensive-code-quality-audit.md
      
      - name: Upload Comprehensive Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: comprehensive-code-quality-audit-report
          path: comprehensive-code-quality-audit.md
          retention-days: 90
      
      - name: Display Report
        if: always()
        run: |
          echo "=========================================="
          cat comprehensive-code-quality-audit.md
          echo "=========================================="

